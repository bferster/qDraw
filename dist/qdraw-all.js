function PieMenu(t,e){var i,s,o,r,n=this;this.ops=t,this.parObj=e,this.active=!1,this.ops.segMode=!1;var a=this.ops.wid/2,p=(this.ops.wid/200*24).toFixed(4),c=a-a/4;this.curSlice=0,void 0==t.sx&&(t.sx=t.x),void 0==t.sy&&(t.sy=t.y),t.x-=a,t.y-=a,this.ops.parent=t.parent?t.parent:"body";var l="<div id='pimenu' class='pi-main unselectable'></div>";for($(this.ops.parent).append(l),l="<img id='piback' class='pi-slice' src='"+this.ops.dial+"'/>",l+="<img id='pihigh' class='pi-slice' style='pointer-events: none' src='"+this.ops.hilite+"'/>",l+="<div id='piicons'>",this.ops.slices[0]&&(l+="<img id='sliceicon0' src='"+this.ops.slices[0].ico+"' style='position:absolute;",l+="left:"+(a-p/2)+"px;top:"+(a-p/2)+"px;width:"+p+"px'/>"),o=1;o<9;++o)this.ops.slices[o]||(this.ops.slices[o]={type:""}),this.ops.slices[o].ico&&(r=45*o-22.5,i=Math.floor(a+(Math.sin(.0174533*r)*c-p/2)),s=Math.floor(a-Math.cos(.0174533*r)*c-p/2),l+="<img id='sliceicon"+o+"' src='"+this.ops.slices[o].ico+"' style='position:absolute;",l+="left:"+i+"px;top:"+s+"px;width:"+p+"px'/>");for(l+="</div>",$("#pimenu").append(l),this.ShowPieMenu(!1),$("#piback").on("mousemove",function(t){var e=n.curSlice,i=0,s="auto",o=-1,r=n.ops.wid/2,a=t.clientX-(n.ops.x+r),p=t.clientY-(n.ops.y+r),c=Math.sqrt(a*a+p*p);if(c<r/5?(i=0,s="pointer",o=0):c>r/2&&(o=Math.floor((180-Math.atan2(a,p)*(180/Math.PI))/n.ops.ang)+1,n.ops.slices[o].type&&(i=1,s="pointer")),o!=e&&c<r&&(n.curSlice=o,n.HideSubMenus(!0),o>=0)){$("#pihigh").css({transform:"rotate("+(o-1)*n.ops.ang+"deg)"});var l=n.ops.slices[o];"col"==l.type?n.ShowColorBars(o,"color",l.def):"edg"==l.type?n.ShowColorBars(o,"edge",l.def):"txt"==l.type?n.ShowColorBars(o,"text",l.def):"men"==l.type?n.ShowMenuPick(o,l.def):"typ"==l.type?n.ShowTextType(o,l.def):"sli"==l.type?n.ShowSlider(o,l.def):"ico"==l.type&&n.ShowIcons(o,l.def)}$("#pihigh").css({opacity:i}),$("#pimenu").css({cursor:s})}),o=1;o<9;++o)"but"==this.ops.slices[o].type&&$("#sliceicon"+o).on("click",function(t){var e=t.currentTarget.id.substr(9)-0;n.SendMessage("click",e)})}function QDraw(t,e,i){var s=this;i=i?i:"body","body"!=i&&(i="#"+i),this.parent=i,this.dockSide=t,this.dockPos=e,this.cVolume=33,this.gridSnap=0,this.numSelect=0,this.showSnap=!0,this.showInfo=!1,this.curUndo=0,this.curRedo=0,this.changed=!1,this.clipboard=[],this.curCurve=0,this.curCol="#e6550d",this.curText="Text",this.curDrop=0,this.curShape=0,this.curAlpha=100,this.curEwid=1,this.curEcol="#000000",this.curEtip=0,this.curTsiz=24,this.curTsty=0,this.curTfon=0,this.segs=[],this.undos=[];var o="<div id='pamenu' class='pa-main unselectable'>";o+="<div id='pacoldot' class='pa-dot unselectable'>",$(i).append(o);var r={id:"qdraw",x:330,y:334,wid:150,ang:45,slices:[]};r.dial="img/piback.png",r.hilite="img/philite.png",r.slices[1]={type:"col",ico:"img/color-icon.png",def:this.curCol+",0,"+this.curDrop},r.slices[2]={type:"edg",ico:"img/edge-icon.png",def:this.curEcol+","+this.curEwid+","+this.curDrop+","+this.curEtip+","+this.curCurve},r.slices[3]={type:"sli",ico:"img/alpha-icon.png",def:100},r.slices[4]={type:"but",ico:"img/redo-icon.png",options:["Redo"]},r.slices[5]={type:"but",ico:"img/undo-icon.png",options:["Undo"]},r.slices[6]={type:"men",ico:"img/align-icon.png",options:["Align:Top:Middle:Bottom:Left:Center:Right","Distribute:Horiz:Vert","Arrange:To back:Backward:Forward:To front"]},r.slices[7]={type:"but",ico:"img/gear-icon.png"},r.slices[8]={type:"ico",ico:"img/draw-icon.png",def:this.curShape},r.slices[8].options=["img/point-icon.png","img/line-icon.png","img/poly-icon.png","img/box-icon.png","img/circle-icon.png","img/text-icon.png"],this.gd=new Gdrive,Sound("click",!0),Sound("ding",!0),Sound("delete",!0),this.pie=new PieMenu(r,this),this.GraphicsInit(),this.DrawMenu(),this.cVolume=this.GetCookie("volume")?this.GetCookie("volume")-0:33,this.gridSnap=this.GetCookie("gridSnap")?this.GetCookie("gridSnap")-0:0,this.showSnap=!!(this.GetCookie("showSnap")-0),this.showInfo=!!(this.GetCookie("showInfo")-0),this.ShowInfoBox(!0),document.onkeyup=$.proxy(this.onKeyUp,this),document.onkeydown==$.proxy(this.onKeyDown,this),$("#pamenu").draggable({containment:"parent",start:function(t,e){$(this).css({"border-radius":"100px"}),s.pie.ShowPieMenu(!1)},stop:function(t,e){var i=.1*$(s.parent).width(),o=.8*$(s.parent).width(),r=.1*$(s.parent).height(),n=.9*$(s.parent).height();t.clientX<i?s.dockSide="left":t.clientX>o?s.dockSide="right":t.clientY<r?s.dockSide="top":t.clientY>n?s.dockSide="bottom":s.dockSide="float",s.pie.ops.sx=t.clientX,s.pie.ops.sy=t.clientY,s.dockPos=null,s.DrawMenu(),Sound("click")}}),$("#pamenu").on("contextmenu",function(t){return $(this).trigger("click"),!1}),$("#pamenu").on("click",function(t){var e=$("#pamenu").position().left+25,i=$("#pamenu").position().top+25,o=s.pie.ops.wid/2;"left"==s.dockSide?(s.pie.ops.x=e+40,s.pie.ops.y=i-o):"right"==s.dockSide?(s.pie.ops.x=e-o-o-108,s.pie.ops.y=i-o):"top"==s.dockSide?(s.pie.ops.y=i+60,s.pie.ops.x=e-o):"bottom"==s.dockSide?(s.pie.ops.y=i-o-o-40,s.pie.ops.x=e-o):"float"==s.dockSide&&(s.pie.ops.y=i-o,s.pie.ops.x=e-o),s.drawMode&&s.drawMode.match(/newxy/)?s.EndDrawing():(s.pie.ShowPieMenu(!s.pie.active),s.DrawMenu())}),$(i).on("mouseup",function(t){"Q-SVG"==t.target.id&&(s.pie.ShowPieMenu(!1),s.DrawMenu())})}function Gdrive(){this.clientId="81792849751-1c76v0vunqu0ev9fgqsfgg9t2sehcvn2.apps.googleusercontent.com",this.scope="https://www.googleapis.com/auth/drive",this.key="AIzaSyAVjuoRt0060MnK_5_C-xenBkgUaxVBEug",this.contentType="image/svg+xml",this.folderName="QDrawings",this.folderId="",this.lastId="",this.lastName=""}PieMenu.prototype.ShowPieMenu=function(t){var e=this.ops;this.active=t;var i=e.wid/2-27;t?($("#pimenu").css({width:"0px",height:"0px"}),$("#pimenu").css({top:e.sy+"px",left:e.sx+"px"}),$("#pimenu").animate({width:e.wid,height:e.wid,top:e.y,left:e.x,opacity:1}),$("#pamenu").animate({top:e.y+i,left:e.x+i}),$("#piicons").animate({width:e.wid,height:e.wid}),$("#piicons").css({display:"initial"})):(this.ops.segMode=!1,this.parObj.curShape=0,this.HideSubMenus(!0),$("#piicons").css({display:"none"}),$("#pimenu").animate({width:0,height:0,top:e.sy,left:e.sx,opacity:1},0),$("#pamenu").animate({top:e.sy-25,left:e.sx-25},0))},PieMenu.prototype.HideSubMenus=function(t){t&&$("#pisubback").remove()},PieMenu.prototype.SetSlice=function(t,e){$("#sliceicon"+t).prop("src",e.ico),this.ops.slices[t]=e},PieMenu.prototype.ShowTextType=function(t,e){var i=this,s=t*this.ops.ang-22.5,o=this.ops.wid/2,r=o+18;x=Math.floor(o+Math.sin(.0174533*s)*r)-7,y=Math.floor(o-Math.cos(.0174533*s)*r)-7,s>180&&(x-=96);var n="<div id='pisubback' class='pi-subbar unselectable'>";n+="<input type='text' class='pi-type' id='pitype' ",e&&(n+="value='"+e+"'"),n+="style='left:"+x+"px;top:"+y+"px'>",$("#pimenu").append(n+"</div>"),$("#pitype").on("change",function(){i.SendMessage("click",i.curSlice+"|"+$("#pitype").val())})},PieMenu.prototype.ShowMenuPick=function(t,e){var i,s,o,r,n,a,p=this,c=this.ops.slices[t],l=c.options.length,d=t*this.ops.ang-11.5-11*l,h=this.ops.wid/2,u=h+16;inSub=!1;var a="<div id='pisubback' class='pi-subbar unselectable'>";for(o=0;o<l;++o)a+="<div class='pi-textopt' id='pitext"+o+"'>",n="",c.options[o]&&(n=c.options[o].split(":")[0]),a+=n+"</div>";for($("#pimenu").append(a+"</div>"),void 0!=e&&$("#pitext"+e).css({opacity:1}),o=0;o<l;++o)n=(d+360)%360>180&&$("#pitext"+o).text()?$("#pitext"+o).css("width").replace(/px/,"")-0:0,i=Math.floor(h+(Math.sin(.0174533*d)*u-n-7)),s=Math.floor(h-Math.cos(.0174533*d)*u-7),d+=18,$("#pitext"+o).css({left:i+"px",top:s+"px"}),$("#pitext"+o).on("mouseover",function(t){if($(this).css({opacity:1}),!inSub){inSub=!0;var e=t.currentTarget.id.substr(6)-0,i=c.options[e].split(":");i.length>1&&$(this).css({"border-radius":"4px",height:"auto"});var s="<div id='pitextsub-0' style='padding-bottom:.5em;font-weight:bold'>"+i[0]+"</div>";for(o=1;o<i.length;++o)s+="<div id='pitextsub-"+o+"'>"+i[o]+"</div>";for($(this).html(s),r=1;r<i.length;++r)$("#pitextsub-"+r).on("mouseover",function(t){$(this).css({color:"#00a8ff"})}),$("#pitextsub-"+r).on("mouseout",function(t){$(this).css({color:"#666"})})}}),$("#pitext"+o).on("mouseout",function(t){if(!t.relatedTarget||"pitextsub-"!=t.relatedTarget.id.substr(0,10)){inSub=!1;var e=t.currentTarget.id.substr(6)-0;$(this).css({opacity:.75,"border-radius":"16px"}),$(this).html(c.options[e].split(":")[0])}}),$("#pitext"+o).on("click",function(t){var e=t.currentTarget.id.substr(6)-0;"pitextsub-0"==t.target.id||(e=10*e+(t.target.id.substr(10)-0)),p.SendMessage("click",p.curSlice+"|"+e),Sound("click")})},PieMenu.prototype.ShowColorBars=function(t,e,i){function s(t){for($("#picoltext").val(i[0]),$("#pitextcol").css("background-color",i[0]),$("#pidrop").css("background-color",i[2]>0?"#00a8ff":"#999"),$("#pidrop").css("color",i[2]>1?"#000":"#fff"),$("#pibold").css("background-color",1&i[4]?"#00a8ff":"#999"),$("#piital").css("background-color",2&i[4]?"#00a8ff":"#999"),$("#picurve").text(i[4]>0?"Curve":"Line"),$("#pifsize").slider("value",i[1]),j=0;j<p.length;++j)$("#piline"+j).css("background-color",p[j]==i[1]?"#00a8ff":"#e8e8e8");for(j=0;j<4;++j)$("#piarr"+j).css("background-color",j==i[3]?"#00a8ff":"#e8e8e8"),1==j&&$("#parr1").css("border-left","6px solid "+(j==i[3]?"#00a8ff":"#e8e8e8")),2==j&&$("#parr2").css("border-right","6px solid "+(j==i[3]?"#00a8ff":"#e8e8e8")),3==j&&($("#parr3").css("border-right","6px solid "+(j==i[3]?"#00a8ff":"#e8e8e8")),$("#parr4").css("border-left","6px solid "+(j==i[3]?"#00a8ff":"#e8e8e8")));t&&a.SendMessage(t,a.curSlice+"|"+i.toString())}var o,r,n,a=this,p=[8,6,4,3,2,1],c=["#0000aa","#3182bd","#6baed6","#9ecae1","#aa0000","#e6550d","#fd8d3c","#fdae6b","#ffcc00","None","#00cc00","#31a354","#74c476","#a1d99b","#756bb1","#9e9ac8","#bcbddc","#ffffff","#cccccc","#888888","#666666","#444444","#000000"],l="<div id='pisubback' class='pi-subbar unselectable' >";for(n=0;n<c.length;++n)l+="<div id='pichip"+n+"' class='pi-colchip'></div>";if("edge"==e){if(l+="<div id='pilinback' class='pi-subbar unselectable' style='width:50px;height:72px'>",this.parObj.curShape<3&&(l+="<div id='picurve' class='pi-fdrop unselectable'></div>"),this.parObj.curShape<5)for(n=0;n<p.length;++n)l+="<div id='piline"+n+"' class='pi-linechip'></div>";if(l+="</div><div id='piarrback' class='pi-subbar unselectable' style='width:50px;height:72px'>",3==this.parObj.curShape)l+="<div id='piarr0' class='pi-arrow'></div>",l+="<div id='piarr1' class='pi-arrow'></div>";else if(this.parObj.curShape<4)for(n=0;n<4;++n)l+="<div id='piarr"+n+"' class='pi-arrow'></div>";this.parObj.curShape<5&&(l+="<div id='pidrop' class='pi-fdrop unselectable'>Drop</div>"),l+="</div>"}$("#pimenu").append(l+"</div>"),$("#pichip9").text("X"),i||(i=["#000000,0,0,0,0,"]),i=i.split(","),i[1]||(i[1]=0),i[2]||(i[2]=0),i[3]||(i[3]=0),i[4]||(i[4]=0),i[5]||(i[5]="");var d=t*this.ops.ang-82.5,h=this.ops.wid/2,u=h+32,g=d+62,f=Math.floor(h+Math.sin(.0174533*g)*u)-3,x=Math.floor(h-Math.cos(.0174533*g)*u)-3;for(g>180&&(f-=58),l="<input type='text' class='pi-coltext' id='picoltext' ",l+="style='left:"+f+"px;top:"+x+"px'>",l+="<div id='pitextcol' class='pi-colchip unselectable' style='",l+="border:.5px solid #999;left:"+(f+49)+"px;top:"+(x+3)+"px;height:7px;width:8px'></div>",5==this.parObj.curShape&&"edge"==e&&(l+="<select class='pi-select' id='pifont'",l+="style='position:absolute;width:64px;left:"+f+"px;top:"+(x-18)+"px'>",l+="<option value='0'>Arial</option>",l+="<option value='1'>Times</option>",l+="<option value='2'>Courier</option></select>",l+="<div id='pibold' class='pi-fstyle unselectable' ",l+="style='left:"+(f+70)+"px;top:"+(x-18)+"px'>B</div>",l+="<div id='piital' class='pi-fstyle unselectable' ",l+="style='left:"+(f+89)+"px;top:"+(x-18)+"px'><i>I</i></div>",l+="<div id='pidrop' class='pi-fdrop unselectable' ",l+="style='left:"+(f+70)+"px;top:"+x+"px'>Drop</div>",l+="<div id='pifsize' class='pi-fstyle unselectable' ",l+="style='width:50px;height:0px;left:"+(f+5)+"px;top:"+(x-32)+"px'></div>",l+="<input type='text' class='pi-coltext' id='pisiztxt' ",l+="style='text-align:center;width:19px;height:9px;left:"+(f+70)+"px;top:"+(x-36)+"px'>",l+="<input type='text' class='pi-coltext' id='pitxt' ",l+="style='width:89px;height:9px;left:"+f+"px;top:"+(x+18)+"px'>"),$("#pisubback").append(l),$("#pitextcol").css("background-color",i[0]),$("#picoltext").val(i[0]),$("#pifont").val(i[3]-0),$("#pifontsty").val(i[4]-0),$("#pisiztxt").val(i[1]),$("#pitxt").val(i[5]),$("#pifsize").slider({min:10,max:99,step:2,value:i[1],slide:function(t,e){$("#pisiztxt").val(e.value)},stop:function(t,e){i[1]=e.value,s("click"),Sound("click")}}),$("#picoltext").on("change",function(){i[0]=$("#picoltext").val(),"#"!=i[0].substr(0,1)&&(i[0]="#"+i[0]),s("click")}),u=h+12,n=0;n<c.length;++n)o=(h+Math.sin(.0174533*d)*u-6).toFixed(4),r=(h-Math.cos(.0174533*d)*u-6).toFixed(4),$("#pichip"+n).css({transform:"translate("+o+"px,"+r+"px) rotate("+d+"deg)","background-color":c[n]}),d+=7,$("#pichip"+n).on("click",function(t){var e=t.currentTarget.id.substr(6)-0;i[0]=c[e],s("click"),Sound("click")}),$("#pichip"+n).on("mouseover",function(t){var o=t.currentTarget.id.substr(6)-0;$(this).css("opacity",.5),"color"==e&&(i[0]=c[o],s())}),$("#pichip"+n).on("mouseout",function(){$(this).css("opacity",1)});for(f+=12,n=0;n<p.length;++n)$("#piline"+n).css({top:13*n+"px",height:p[n]+1+"px"}),$("#piline"+n).on("mouseover",function(){$(this).css("opacity",.5)}),$("#piline"+n).on("mouseout",function(){$(this).css("opacity",1)}),$("#piline"+n).on("click",function(t){var e=t.currentTarget.id.substr(6)-0;i[1]=p[e],Sound("click"),s("click")});for(n=0;n<4;++n)$("#piarr"+n).css({top:19*n+10+"px"}),$("#piarr"+n).on("mouseover",function(t){$(this).css("opacity",.5)}),$("#piarr"+n).on("mouseout",function(t){$(this).css("opacity",1)}),$("#piarr"+n).on("click",function(t){var e=t.currentTarget.id.substr(5)-0;i[3]=e,Sound("click"),s("click")});3==this.parObj.curShape?($("#piarr0").css({height:"10px",left:"0px",top:"10px"}),$("#piarr1").css({height:"10px",left:"0px",top:"28px","border-radius":"4px"}),$("#pidrop").css({height:"12px",left:"-5px",top:"46px"})):4==this.parObj.curShape?$("#pidrop").css({height:"12px",left:"-5px",top:"8px"}):this.parObj.curShape<3&&($("#piarr1").append("<div id='parr1' class='pi-rarr' style='left:16px;top:-5px'</div>"),$("#piarr2").append("<div id='parr2' class='pi-larr' style='left:-2px;top:-5px'</div>"),$("#piarr3").append("<div id='parr3' class='pi-larr' style='left:-2px;top:-5px'</div>"),$("#piarr3").append("<div id='parr4' class='pi-rarr' style='left:16px;top:-5px'</div>"),$("#pidrop").css({height:"12px",left:"-5px",top:"84px"}),$("#picurve").css({height:"12px",left:"5px",top:"-20px"})),$("#pilinback").css({left:f+"px",top:x-4-12*p.length+"px",height:12*p.length+"px"}),$("#piarrback").css({left:f+10+"px",top:x+15+"px"}),s(),$("#pifont").on("change",function(){i[3]=$(this).val(),s("click"),Sound("click")}),$("#pibold").on("click",function(){1&i[4]?i[4]&=2:i[4]|=1,s("click"),Sound("click")}),$("#piital").on("click",function(){2&i[4]?i[4]&=1:i[4]|=2,s("click"),Sound("click")}),$("#pidrop").on("click",function(){i[2]=(i[2]-0+1)%3,s("click"),Sound("click")}),$("#picurve").on("click",function(){i[4]=(i[4]-0+1)%2,s("click"),Sound("click")}),$("#pisiztxt").on("change",function(t){i[1]=$(this).val(),s("click"),Sound("click")}),$("#pitxt").on("change",function(){i[5]=$(this).val(),s("click"),Sound("click")})},PieMenu.prototype.ShowSlider=function(t,e){function i(e){e=e?e:0,e=Math.max(0,Math.min(e,100)),$("#pislitext").val(e);var i=t*n.ops.ang-52.5;i=.0174533*(i+.6*e),s=Math.floor(Math.sin(i)*l+c)-5,o=Math.floor(c-Math.cos(i)*l)-5,$("#pislidot").css({left:+s+"px",top:+o+"px"})}var s,o,r,n=this,a="<div id='pisubback' class='pi-subbar unselectable'>";for(r=0;r<60;++r)a+="<div id='piarc"+r+"' class='pi-sliarc'></div>";a+="<div id='pislidot' class='pi-slidot'></div>",$("#pimenu").append(a+"</div>");var p=t*this.ops.ang-22.5-30,c=this.ops.wid/2,l=c+16,d=p+28;for(s=Math.floor(c+Math.sin(.0174533*d)*(l+18))-7,o=Math.floor(c-Math.cos(.0174533*d)*(l+18))-7,a="<input type='text' class='pi-coltext' id='pislitext' ",a+="style='left:"+s+"px;top:"+o+"px;width:16px;text-align:center'>",$("#pisubback").append(a),i(e),$("#pislidot").draggable({drag:function(t,e){var i=n.ops.wid/2,s=t.clientX-(n.ops.x+i),o=t.clientY-(n.ops.y+i),r=Math.floor(180-57.296*Math.atan2(s,o));r<60&&p>270&&(r+=360),r=Math.max(0,Math.min(r-p,60));var a=.0174533*(r+p);s=Math.floor(Math.sin(a)*l+i)-5,o=Math.floor(i-Math.cos(a)*l)-5,e.position.left=s,e.position.top=o;var c=Math.round(r/.6);$("#pislitext").val(c)},stop:function(t,e){var s=$("#pislitext").val();i(s),n.SendMessage("click",n.curSlice+"|"+s),Sound("click")}}),$("#pislitext").on("change",function(){var t=$(this).val();t=t?t:0,t=Math.max(0,Math.min(t,100)),i(t)}),d=p,r=0;r<60;++r)s=(c+Math.sin(.0174533*d)*l).toFixed(4),o=(c-Math.cos(.0174533*d)*l).toFixed(4),$("#piarc"+r).css({transform:"translate("+s+"px,"+o+"px) rotate("+p+"deg)"}),d+=1,$("#piarc"+r).on("click",function(t){var e=t.currentTarget.id.substr(5)-0;i(Math.floor(1.666*e))})},PieMenu.prototype.ShowIcons=function(t,e){var i,s,o,r,n=this,a=this.ops.slices[t],p=a.options.length,c=t*this.ops.ang-11.5-11*p,l=this.ops.wid/2,d=l+10,r="<div id='pisubback' class='pi-subbar unselectable'>";for(o=0;o<p;++o)r+="<div class='pi-icon' id='piicon"+o+"'>",r+="<img src='"+a.options[o]+"' width='18'></img></div>";for($("#pimenu").append(r+"</div>"),void 0!=e&&$("#piicon"+e).css({opacity:1}),o=0;o<p;++o)i=Math.floor(l+(Math.sin(.0174533*c)*d-14)),s=Math.floor(l-Math.cos(.0174533*c)*d-14),c+=19,$("#piicon"+o).css({left:i+"px",top:s+"px"}),$("#piicon"+o).on("mouseover",function(t){for(var e=t.currentTarget.id.substr(6)-0,i=0;i<p;++i)$("#piicon"+i).css({opacity:i==e?1:.75})}),$("#piicon"+o).on("click",function(t){var e=t.currentTarget.id.substr(6)-0;n.SendMessage("click",n.curSlice+"|"+e),Sound("click")})},PieMenu.prototype.SendMessage=function(t,e){var i=t+"|"+this.ops.id;e&&(i+="|"+e),window.parent.postMessage(i,"*")},QDraw.prototype.DrawMenu=function(){var t=this.curCol,e=["point","line","poly","box","circle","text"],i=$(this.parent).position().left+$(this.parent).width()-50,s=$(this.parent).position().top+$(this.parent).height()-50;t&&"None"!=t||(t="transparent"),$("#pacoldot").css({background:t+" url('img/"+e[this.curShape]+"-icon.png') no-repeat center center"}),$("#pacoldot").css({"background-size":"20px 20px",opacity:this.curAlpha/100});var o=this.pie.ops;o.slices[1]={type:"col",ico:"img/color-icon.png",def:this.curCol+",0,"+this.curDrop},5==this.curShape?this.pie.SetSlice(2,{type:"edg",ico:"img/font-icon.png",def:this.curCol+","+this.curTsiz+","+this.curDrop+","+this.curTfon+","+this.curTsty+","+this.curText}):this.pie.SetSlice(2,{type:"edg",ico:"img/edge-icon.png",def:this.curEcol+","+this.curEwid+","+this.curDrop+","+this.curEtip+","+this.curCurve}),o.slices[3]={type:"sli",ico:"img/alpha-icon.png",def:this.curAlpha},o.slices[8]={type:"ico",ico:"img/draw-icon.png",def:this.curShape},o.slices[8].options=["img/point-icon.png","img/line-icon.png","img/poly-icon.png","img/box-icon.png","img/circle-icon.png","img/text-icon.png"],t="None"==this.curEcol?this.curCol:this.curEcol,$("#pacoldot").css({border:"2px solid "+t}),this.pie.active?$("#pamenu").css({"border-radius":"100px"}):"left"==this.dockSide?$("#pamenu").css({"border-radius":"0px",left:"0px","border-top-right-radius":"100px","border-bottom-right-radius":"100px",top:this.dockPos+"%"}):"right"==this.dockSide?$("#pamenu").css({"border-radius":"0px",left:i+"px","border-top-left-radius":"100px","border-bottom-left-radius":"100px",top:this.dockPos+"%"}):"top"==this.dockSide?$("#pamenu").css({"border-radius":"0px",top:"0px","border-bottom-left-radius":"100px","border-bottom-right-radius":"100px",left:this.dockPos+"%"}):"bottom"==this.dockSide?$("#pamenu").css({"border-radius":"0px",top:s+"px","border-top-left-radius":"100px","border-top-right-radius":"100px",left:this.dockPos+"%"}):"float"==this.dockSide&&$("#pamenu").css({top:this.sx+"px",left:this.sy+"px"})},QDraw.prototype.HandleMessage=function(t){var e,i=t.split("|");if("qdraw"==i[1]&&"click"==i[0]){switch(i[2]&&(this.pie.ops.slices[i[2]].def=i[3]),i[3]&&(e=i[3].split(",")),i[2]-0){case 1:this.curCol=e[0],this.StyleSelectedSegs(this.changed=!0);break;case 2:5==this.curShape?(this.curCol=e[0],this.curTsiz=e[1],this.curDrop=e[2],this.curTfon=e[3],this.curTsty=e[4],this.curText=e[5]):(this.curEcol=e[0],this.curEwid=e[1],this.curDrop=e[2],this.curEtip=e[3],this.curCurve=void 0==e[4]?0:e[4]),this.StyleSelectedSegs(this.changed=!0);break;case 3:this.curAlpha=e[0],this.StyleSelectedSegs(this.changed=!0);break;case 4:this.ReDo();break;case 5:this.UnDo();break;case 6:e[0]<11?this.AlignSegs(e[0]%10):e[0]<21?this.AlignSegs(e[0]%10+10):e[0]<31&&this.ArrangeSegs(e[0]%10);break;case 7:this.Settings();break;case 8:this.curShape=e[0],this.DrawShape(this.curShape)}this.DrawMenu()}},QDraw.prototype.Settings=function(){var t=this,e="<table style='font-size:10px;color:#666'>";e+="<tr style='height:18px'><td><b>Click volume&nbsp;&nbsp;&nbsp;&nbsp;</b></td>",e+="<td><div id='cvol' class='unselectable' style='width:80px;display:inline-block'></div>&nbsp;&nbsp;&nbsp;&nbsp;",e+="<div id='cvolt' class='unselectable' style='display:inline-block'>"+this.cVolume+"</div></td></tr>",e+="<tr style='height:18px'><td><b>Grid snap</b></td>",e+="<td><div id='csnap' class='unselectable' style='width:80px;display:inline-block'></div>&nbsp;&nbsp;&nbsp;",e+="<div id='csnapt' class='unselectable' style='display:inline-block'>"+(this.gridSnap?this.gridSnap:"Off")+"</div></td></tr>",e+="<tr style='height:18px'><td><b>See snap lines</b></td>",e+="<td><input type=checkbox id='lsnap' class='unselectable'"+(this.showSnap?" checked":"")+"></td></tr>",e+="<tr style='height:18px'><td><b>See x/y info</b></td>",e+="<td><input type=checkbox id='sinfo' class='unselectable'"+(this.showInfo?" checked":"")+"></td></tr>",e+="<tr style='height:18px'><td><b>Save/load</b></td>",e+="<td><select class='pi-select' style='padding-top:0px;' id='csave'><option></option>",e+="<option>Load</option><option>Save</option>",e+="<option>Save As...</option><option>Clear</option></select></td></tr>",e+="<tr><td><b>This drawing</b></td><td id='sfname'>"+(this.gd.lastName?this.gd.lastName:"None")+"</td></tr>",e+="<tr><td><br></td></tr>",e+="<tr><td><b>Help</b></td><td><a href='https://docs.google.com/document/d/1oTbVfuBwFQvgo8EZogyuoXBu7ErCK0oAH3Ny8N_E_Mg/edit?usp=sharing' target='_blank'>",e+="<img src='img/helpicon.gif' style='vertical-align:bottom' title='Show help'></a></td></tr>",e+="</table>",this.Dialog("Settings",e,270,function(){t.cVolume=$("#cvolt").text(),t.gridSnap=$("#csnap").slider("value"),t.SetCookie("volume",t.cVolume,365),t.SetCookie("gridSnap",t.gridSnap,365),t.SetCookie("showSnap",t.showSnap?1:0,365),t.SetCookie("showInfo",t.showInfo?1:0,365)}),$("#lsnap").on("click",function(){t.showSnap=!t.showSnap}),$("#sinfo").on("click",function(){t.showInfo=!t.showInfo,t.ShowInfoBox(!0)}),$("#cvol").slider({min:0,max:100,value:t.cVolume,slide:function(t,e){$("#cvolt").text(e.value)}}),$("#csnap").slider({min:0,max:100,step:5,value:t.gridSnap,slide:function(t,e){$("#csnapt").text(e.value?e.value:"Off")}}),$("#csave").on("change",function(){var e,i=$(this).val();$(this).val(""),x=new XMLSerializer;var s="<!-- "+JSON.stringify(t.segs)+" -->\n",o=$(t.parent).width(),r=$(t.parent).height();for(s+='<svg viewBox="0 0 '+o+" "+r+'" xmlns="http://www.w3.org/2000/svg">\n',e=0;e<t.segs.length;++e)s+=x.serializeToString(t.segs[e].svg)+"\n";s+="</svg>","Save As..."==i||"Save"==i&&!t.gd.lastId?t.GetTextBox("Type name of new drawing","","",function(e){t.gd.AccessAPI(function(){t.gd.CreateFolder(t.gd.folderName,function(i){t.gd.Upload(e,s,null,function(e){$("#sfname").text(t.gd.lastName?t.gd.lastName:"None")})})})}):"Save"==i?t.gd.AccessAPI(function(){t.gd.CreateFolder(t.gd.folderName,function(e){t.gd.Upload($("#myName").val(),s,t.gd.lastId?t.gd.lastId:"",function(e){$("#sfname").text(t.gd.lastName?t.gd.lastName:"None"),Sound("ding")})})}):"Load"==i?t.gd.AccessAPI(function(){t.gd.CreateFolder(t.gd.folderName,function(e){t.gd.Picker(!0,function(e){t.gd.AccessAPI(function(){t.gd.Download(t.gd.lastId,function(e){$("#sfname").text(t.gd.lastName?t.gd.lastName:"None");var i=e.match(/<!-- (.+) -->/)[1];t.Do(),t.segs=$.parseJSON(i),t.RefreshSVG(),Sound("ding")})})})})}):"Clear"==i&&t.ConfirmBox("Are you sure?",function(){t.gd.lastId=null,t.gd.lastName="",t.Do(),t.segs=[],t.RefreshSVG(),Sound("delete")})})},QDraw.prototype.ShowInfoBox=function(t){var e;t&&($("#infoboxDiv").remove(),this.showInfo&&(e="<div class='pi-infobox' id='infoboxDiv'></div>",$(this.parent).append(e),$("#infoboxDiv").draggable({containment:"parent"}),this.mx=this.my=0)),e="&nbsp;"+this.mx+","+this.my+"&nbsp;",$("#infoboxDiv").html(e)},QDraw.prototype.Do=function(t){var e={};return e.date=(new Date).toString().substr(0,21),e.script=this.segs,t&&(e.script=this.tempSeg),!!e.script&&(this.undos[this.curUndo]=$.parseJSON(JSON.stringify(e)),this.undos[this.curUndo].svg=null,this.curRedo=0,this.changed=!1,this.curUndo++,this.SetUndoStatus(),void(this.tempSeg=null))},QDraw.prototype.UnDo=function(){var t={};if(!(this.curUndo<1)){t.date=(new Date).toString().substr(0,21),t.script=this.segs,this.undos[this.curUndo]=$.parseJSON(JSON.stringify(t)),this.undos[this.curUndo].svg=null;var t=this.undos[this.curUndo-1];this.segs=t.script,this.RefreshSVG(),Sound("delete"),this.curRedo++,this.curUndo--,this.SetUndoStatus()}},QDraw.prototype.ReDo=function(){if(this.curRedo){var t=this.undos[this.curUndo+1];this.segs=t.script,this.RefreshSVG(),Sound("ding"),this.curUndo++,this.curRedo--,this.SetUndoStatus()}},QDraw.prototype.SetUndoStatus=function(){$("#sliceicon5").css("opacity",this.curUndo>1?1:.33),$("#sliceicon4").css("opacity",this.curRedo>0?1:.33)},QDraw.prototype.ClipboardCut=function(){for(this.Do(),this.ClipboardCopy(),i=this.segs.length-1;i>=0;--i)this.segs[i].select&&($("#QWire-"+i).remove(),$("#QSeg-"+i).remove(),this.segs.splice(i,1));this.RefreshIds(),Sound("delete")},QDraw.prototype.ClipboardCopy=function(){var t;for(this.clipboard=[],t=0;t<this.segs.length;++t)this.segs[t].select&&this.clipboard.push(JSON.parse(JSON.stringify(this.segs[t])));this.clipboard.length&&Sound("click")},QDraw.prototype.ClipboardPaste=function(){var t;for(this.Do(),this.DeselectSegs(),t=0;t<this.clipboard.length;++t)this.clipboard[t].svg=null,this.segs.push(this.clipboard[t]),this.AddSeg(this.segs.length-1),this.StyleSeg(this.segs.length-1);this.clipboard.length&&Sound("ding")},QDraw.prototype.onKeyUp=function(t){"z"==t.key&&t.ctrlKey?this.UnDo():"Z"==t.key&&t.ctrlKey?this.ReDo():"y"==t.key&&t.ctrlKey?this.ReDo():"c"==t.key&&t.ctrlKey?this.ClipboardCopy():"v"==t.key&&t.ctrlKey?this.ClipboardPaste():"x"==t.key&&t.ctrlKey?this.ClipboardCut():27==t.keyCode?this.EndDrawing():8==t.keyCode&&this.RemoveLastPoint()},QDraw.prototype.onKeyDown=function(t){if(8==t.keyCode&&"TEXTAREA"!=t.target.tagName&&"INPUT"!=t.target.tagName)return t.stopPropagation(),!1},Gdrive.prototype.AccessAPI=function(t,e){function i(s){s&&!s.error?gapi.client.load("drive","v2",function(){t(e)}):gapi.auth.authorize({client_id:this.clientId,scope:this.scope,immediate:!1},i)}gapi.auth.authorize({client_id:this.clientId,scope:this.scope,immediate:!0},i)},Gdrive.prototype.Download=function(t,e){var i=gapi.client.drive.files.get({fileId:t});i.execute(function(t){if(t.downloadUrl){var i=gapi.auth.getToken().access_token,s=new XMLHttpRequest;s.open("GET",t.downloadUrl),s.setRequestHeader("Authorization","Bearer "+i),s.onload=function(){e(s.responseText)},s.send()}})},Gdrive.prototype.CreateFolder=function(t,e){var i=this,s=gapi.auth.getToken().access_token,o=gapi.client.drive.files.list({q:"title='"+t+"' and mimeType='application/vnd.google-apps.folder' and trashed = false"});o.execute(function(o){if(o.items.length)i.folderId=o.items[0].id,e(i.folderId);else{var r=gapi.client.request({path:"/drive/v2/files/",method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:{title:t,mimeType:"application/vnd.google-apps.folder"}});r.execute(function(t){i.folderId=t.id,e(i.folderId)})}})},Gdrive.prototype.Upload=function(t,e,i,s){const o="-------314159265358979323846264",r="\r\n--"+o+"\r\n",n="\r\n--"+o+"--";var a={title:t,mimeType:this.contentType,parents:[{id:this.folderId}]},p=btoa(e),c=this;i=i?"/"+i:"";var l=r+"Content-Type: application/json\r\n\r\n"+JSON.stringify(a)+r+"Content-Type: "+this.contentType+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+p+n,d=gapi.client.request({path:"/upload/drive/v2/files"+i,method:i?"PUT":"POST",params:i?{uploadType:"multipart",alt:"json"}:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+o+'"'},body:l});d.execute(function(t){c.lastId=t.id,c.lastName=t.title,s(t)})},Gdrive.prototype.Picker=function(t,e){function i(t,e){function i(){if(n&&r){var e=(new google.picker.DocsView).setOwnedByMe(t).setParent(s.folderId).setIncludeFolders(!0),i=(new google.picker.PickerBuilder).addView(e).setOAuthToken(r).setDeveloperKey(s.key).setCallback(o).setSelectableMimeTypes(s.contentType).build();i.setVisible(!0)}}function o(t){if(t[google.picker.Response.ACTION]==google.picker.Action.PICKED){var i=t[google.picker.Response.DOCUMENTS][0];s.lastId=i.id,s.lastName=i.name,e(i)}}var r,n=!1;gapi.load("auth",{callback:function(){window.gapi.auth.authorize({client_id:s.clientId,scope:[s.scope],immediate:!1},function(t){t&&!t.error&&(r=t.access_token,i())})}}),gapi.load("picker",{callback:function(){n=!0,i()}})}var s=this;i(t,function(t){e(t.url)})},QDraw.prototype.SetCookie=function(t,e,i){var s=new Date;s.setTime(s.getTime()+24*i*60*60*1e3);var o="expires="+s.toGMTString();document.cookie=t+"="+e+"; "+o},QDraw.prototype.GetCookie=function(t){for(var e,i=t+"=",s=document.cookie.split(";"),o=0;o<s.length;o++)if(e=s[o].trim(),0==e.indexOf(i))return e.substring(i.length,e.length);return""},QDraw.prototype.GetTextBox=function(t,e,i,s){$("#alertBoxDiv").remove(),$("body").append("<div class='unselectable' id='alertBoxDiv'></div>");var o="<p><img src='img/shantilogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";o+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+t+"</b></span><p>",o+="<div style='font-size:14px;margin:14px'>"+e,o+="<p><input class='is' type='text' id='gtBoxTt' value='"+i+"'></p></div>",$("#alertBoxDiv").append(o),$("#alertBoxDiv").dialog({width:400,buttons:{OK:function(){Sound("click"),s($("#gtBoxTt").val()),$(this).remove()},Cancel:function(){Sound("delete"),$(this).remove()}}}),$("#alertBoxDiv").dialog("option","position",{my:"center",at:"center",of:this.parent}),$("#gtBoxTt").on("change",function(){s($(this).val()),$("#alertBoxDiv").remove()})},QDraw.prototype.Dialog=function(t,e,i,s,o){$("#dialogDiv").remove(),$("body").append("<div class='unselectable' id='dialogDiv'></div>");var r="<p><img src='img/shantilogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";r+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+t+"</b></span><p>",r+="<div style='font-size:14px;margin:14px'>"+e+"</div>",$("#dialogDiv").append(r),$("#dialogDiv").dialog({width:i,buttons:{OK:function(){Sound("click"),s&&s(),$(this).remove()},Cancel:function(){Sound("delete"),o&&o(),$(this).remove()}}}),$("#dialogDiv").dialog("option","position",{my:"center",at:"center",of:this.parent})},QDraw.prototype.ConfirmBox=function(t,e){$("body").append("<div class='unselectable' id='confirmBoxDiv'></div>");var i="<p><img src='images/qlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";i+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>Are you sure?</b></span><p>",i+="<div style='font-size:14px;margin:14px'>"+t+"</div>",$("#confirmBoxDiv").append(i),$("#confirmBoxDiv").dialog({width:400,buttons:{Yes:function(){Sound("click"),$(this).remove(),e()},No:function(){Sound("delete"),$(this).remove();
}}}),Sound("ding"),$("#confirmBoxDiv").dialog("option","position",{my:"center",at:"center",of:this.parent})},QDraw.prototype.GraphicsInit=function(){var t,e=this;this.segs=[],this.drawMode="",this.drawX=0,this.drawY=0,this.NS="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.NS,"svg"),this.svg.setAttribute("id","Q-SVG"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.addEventListener("click",function(t){if(!e.drawMode||!e.drawMode.match(/newxy/))return t.altKey?void e.AddPointToSeg(t.clientX,t.clientY):void(0==e.curShape&&"Q-SVG"==t.target.id?(e.DeselectSegs(),Sound("click")):"QSeg-"!=t.target.id.substr(0,5)&&(e.curShape=0))}),this.svg.addEventListener("mousemove",function(t){var i,s,o,r,n,p,c=e.drawMode.split("-");if(e.mx=t.clientX,e.my=t.clientY,e.ShowInfoBox(),"newxy"==c[0]&&1==c[1])e.Rubberband(c[2],e.drawX,e.drawY,t.clientX,t.clientY,t.shiftKey);else if("ds"==c[0]&&0==c[2]){for(e.Do(!0),o=e.segs[c[1]],p=t.clientY-o.y[0]-e.mouseDY,n=t.clientX-o.x[0]-e.mouseDX,s=0;s<e.segs.length;++s)if(e.segs[s].select)for(o=e.segs[s],r=o.x.length,i=0;i<r;++i)o.x[i]+=n,o.y[i]+=p,e.gridSnap&&(o.x[i]-=o.x[i]%e.gridSnap,o.y[i]-=o.y[i]%e.gridSnap),e.StyleSeg(s),e.AddWireframe(s)}else if("ds"==c[0]&&c[2]){e.Do(!0);var o=e.segs[c[1]],l=t.clientX,d=t.clientY;if(e.gridSnap&&(l-=l%e.gridSnap,d-=d%e.gridSnap),o.type<3){if(t.shiftKey&&c[2]>0){var h=1==c[2]?c[2]:c[2]-2;n=l-o.x[h],p=d-o.y[h],a=180-Math.atan2(n,p)*(180/Math.PI),a<45?l=o.x[h]:a<135?d=o.y[h]:a<225?l=o.x[h]:a<315?d=o.y[h]:l=o.x[h]}o.x[c[2]-1]=l,o.y[c[2]-1]=d}if(3==o.type||4==o.type)if(o.x[c[2]-1]=l,o.y[c[2]-1]=d,t.shiftKey){var u=Math.abs(o.x[1]-o.x[0]);Math.abs(o.y[2]-o.y[1]);1==c[2]?(o.y[1]=o.y[0]=o.y[2]-u,o.x[3]=o.x[0]):2==c[2]?(o.y[0]=o.y[1]=o.y[2]-u,o.x[2]=o.x[1]):3==c[2]?(o.y[3]=o.y[2]=o.y[1]+u,o.x[1]=o.x[2]):4==c[2]&&(o.y[2]=o.y[3]=o.y[1]+u,o.x[0]=o.x[3])}else 1==c[2]?(o.y[1]=o.y[0],o.x[3]=o.x[0]):2==c[2]?(o.y[0]=o.y[1],o.x[2]=o.x[1]):3==c[2]?(o.y[3]=o.y[2],o.x[1]=o.x[2]):4==c[2]&&(o.y[2]=o.y[3],o.x[0]=o.x[3]);e.StyleSeg(c[1]),e.AddWireframe(c[1])}}),this.svg.addEventListener("mousedown",function(t){var i=e.drawMode.split("-");if("newxy"==i[0]&&0==i[1]){if(1==i[2]||2==i[2])e.Do(),e.segs.push({type:i[2],col:e.curCol,ewid:e.curEwid,ecol:e.curEcol,alpha:e.curAlpha,drop:e.curDrop,select:!1,etip:e.curEtip,curve:e.curCurve,x:[],y:[]}),e.AddSeg(e.segs.length-1),e.StyleSeg(e.segs.length-1);else if(5==i[2])return e.GetTextBox("Type Text","","",function(s){e.Do(),e.drawMode="",e.segs.push({type:i[2],col:e.curCol,tsiz:e.curTsiz,tsty:e.curTsty,alpha:e.curAlpha,drop:e.curDrop,select:!1,tfon:e.curTfon,text:s,x:[t.clientX],y:[t.clientY]}),e.AddSeg(e.segs.length-1),e.StyleSeg(e.segs.length-1),Sound("ding")}),void $("#Q-SVG").attr("cursor","default");e.drawX=t.clientX,e.drawY=t.clientY,e.drawMode="newxy-1-"+i[2]}"newxy"==i[0]&&(e.drawX=t.clientX,e.drawY=t.clientY,e.drawMode="newxy-1-"+i[2])}),this.svg.addEventListener("mouseup",function(t){var i=e.drawMode.split("-"),s=e.drawX,o=e.drawY,r=t.clientX,n=t.clientY;if(e.gridSnap&&(s-=s%e.gridSnap,o-=o%e.gridSnap,r-=r%e.gridSnap,n-=n%e.gridSnap),"newxy"==i[0]&&1==i[1])if(1==i[2]||2==i[2]){var p=e.segs.length-1;if(t.shiftKey){var c=e.segs[p].x.length-1;s=e.segs[p].x[c],o=e.segs[p].y[c],dx=r-s,dy=n-o,a=180-Math.atan2(dx,dy)*(180/Math.PI),a<45?r=s:a<135?n=o:a<225?r=s:a<315?n=o:r=s}e.segs[p].x.push(r),e.segs[p].y.push(n),e.StyleSeg(p)}else 3!=i[2]&&4!=i[2]||(t.shiftKey&&(n=o+Math.abs(r-s)),e.Do(),e.Rubberband(0),e.drawMode="",e.segs.push({type:i[2],col:e.curCol,ewid:e.curEwid,ecol:e.curEcol,alpha:e.curAlpha,drop:e.curDrop,select:!1,etip:e.curEtip,x:[s,r,r,s],y:[o,o,n,n]}),e.AddSeg(e.segs.length-1),e.StyleSeg(e.segs.length-1),$("#Q-SVG").attr("cursor","default"),Sound("ding"));else"ds"==i[0]&&(e.drawMode="de-"+i[1]+"-"+i[2])}),document.getElementById("containerDiv").appendChild(this.svg),$(this.svg).on("contextmenu",function(){return!1}),this.RefreshSVG();var i;for(t=0;t<4;t++)i=30*t,this.segs[t]={type:3,col:"#cccccc",ewid:1,ecol:"#990000",alpha:100,drop:0,select:!1,x:[20+i,120+i,120+i,20+i],y:[50+i,50+i,250+i,250+i]},this.AddSeg(t),this.StyleSeg(t);i+=30,this.segs[t]={type:4,col:"#cccccc",ewid:1,ecol:"#000099",alpha:100,drop:0,select:!1,x:[20+i,120+i,120+i,20+i],y:[50+i,50+i,150+i,150+i]},this.AddSeg(t),this.StyleSeg(t++),i+=30,this.segs[t]={type:2,col:"#cccccc",ewid:1,ecol:"#990000",alpha:100,drop:0,select:!1,curve:0,x:[20+i,120+i,120+i],y:[50+i,50+i,250+i]},this.AddSeg(t),this.StyleSeg(t++),i+=30,this.segs[t]={type:1,col:"#cccccc",ewid:4,ecol:"#990000",alpha:100,drop:0,select:!1,curve:0,x:[20+i,120+i,120+i],y:[50+i,50+i,250+i]},this.AddSeg(t),this.StyleSeg(t++),i+=30,this.segs[t]={type:5,col:"#009900",tsiz:60,tsty:0,tfon:0,alpha:100,drop:0,select:!1,text:"ABC",x:[20+i],y:[50+i]},this.AddSeg(t),this.StyleSeg(t++)},QDraw.prototype.RefreshSVG=function(){var t,e=this.segs.length;for(this.tempSeg=null,$("#Q-SVG").empty(),this.AddDropFilter("QdropFilterB","#000000",4),this.AddDropFilter("QdropFilterW","#ffffff",4),this.AddDropFilter("QdropFilterR","#ffffff",2),t=0;t<e;++t)this.segs[t].svg=null,this.AddSeg(t),this.StyleSeg(t)},QDraw.prototype.StyleSeg=function(t){var e=this.segs[t],i=e.svg;if(e.type<3&&e.x.length>1){if(1==e.type&&e.etip>0){var s,o=4*e.ewid,r=[],n=[];if(i.childNodes[1].setAttribute("d",""),i.childNodes[2].setAttribute("d",""),2&e.etip){s=Math.atan2(e.y[0]-e.y[1],e.x[0]-e.x[1]),r[0]=e.x[0]-o*Math.cos(s-Math.PI/6),n[0]=e.y[0]-o*Math.sin(s-Math.PI/6),r[1]=e.x[0],n[1]=e.y[0],r[2]=e.x[0]-o*Math.cos(s+Math.PI/6),n[2]=e.y[0]-o*Math.sin(s+Math.PI/6);var a="M"+r[0]+" "+n[0];a+=" L"+r[1]+" "+n[1],a+=" L"+r[2]+" "+n[2],a+=" Z",i.childNodes[1].setAttribute("d",a),i.childNodes[1].style.fill=e.col}if(1&e.etip){var p=e.x.length-1;s=Math.atan2(e.y[p]-e.y[p-1],e.x[p]-e.x[p-1]),r[0]=e.x[p]-o*Math.cos(s-Math.PI/6),n[0]=e.y[p]-o*Math.sin(s-Math.PI/6),r[1]=e.x[p],n[1]=e.y[p],r[2]=e.x[p]-o*Math.cos(s+Math.PI/6),n[2]=e.y[p]-o*Math.sin(s+Math.PI/6),a="M"+r[0]+" "+n[0],a+=" L"+r[1]+" "+n[1],a+=" L"+r[2]+" "+n[2],a+=" Z",i.childNodes[2].setAttribute("d",a),i.childNodes[2].style.fill=e.col}}var a="M"+e.x[0]+" "+e.y[0];if(e.curve>0){var c=!0;for(Math.abs(e.x[0]-e.x[e.x.length-1])<3&&Math.abs(e.y[0]-e.y[e.y.length-1])<3&&(e.x[x.length-1]=e.x[0],e.y[y.length-1]=e.y[0],c=!1),x=e.x[0]-0+(e.x[1]-e.x[0])/2-0,y=e.y[0]-0+(e.y[1]-e.y[0])/2-0,c&&(a+="L"+x+",",a+=y+" "),j=1;j<e.x.length-1;++j)x=e.x[j]-0+(e.x[j+1]-e.x[j])/2-0,y=e.y[j]-0+(e.y[j+1]-e.y[j])/2-0,a+="Q",a+=e.x[j]+",",a+=e.y[j]+" ",a+=x+",",a+=y+" ";c&&(a+="L"+e.x[j]+",",a+=e.y[j]+" ")}else for(j=1;j<e.x.length;++j)a+="L",a+=e.x[j]+",",a+=e.y[j]+" ";2==e.type?a+=" Z":e.col="",1==e.type?i.childNodes[0].setAttribute("d",a):i.setAttribute("d",a)}else if("3"==e.type){var l=0;i.setAttribute("height",Math.abs(e.y[2]-e.y[0])),i.setAttribute("width",Math.abs(e.x[2]-e.x[0])),i.setAttribute("x",e.x[0]),i.setAttribute("y",e.y[0]),1==e.etip&&(l=Math.abs(e.x[2]-e.x[0])/10),i.setAttribute("rx",l),i.setAttribute("ry",l)}else if("4"==e.type){var d=Math.abs(e.x[2]-e.x[0])/2;i.setAttribute("rx",d);var h=Math.abs(e.y[2]-e.y[0])/2;i.setAttribute("ry",h),i.setAttribute("cx",e.x[0]+d),i.setAttribute("cy",e.y[0]+h)}else if("5"==e.type){var u=["sans-serif","serif","courier"];i.setAttribute("x",e.x[0]),i.setAttribute("y",e.y[0]),i.setAttribute("fill",e.col),i.setAttribute("font-size",e.tsiz),i.setAttribute("font-family",u[e.tfon]),i.setAttribute("font-style",2&e.tsty?"italic":"normal"),i.setAttribute("font-weight",1&e.tsty?"bold":"normal"),$(i).css("user-select","none"),$(i).text(e.text)}i.setAttribute("opacity",e.alpha/100),"5"!=e.type&&(i.setAttribute("stroke-width",(e.type<3?2*e.ewid:e.ewid)+"px"),e.col?i.style.fill=e.col:i.style.fill="none",e.ecol?i.style.stroke=e.ecol:i.style.stroke="none"),1==e.drop?i.setAttribute("filter","url(#QdropFilterW)"):2==e.drop?i.setAttribute("filter","url(#QdropFilterB)"):i.setAttribute("filter","")},QDraw.prototype.SelectSeg=function(t,e){var i,s=0,o=this.segs[t],r=this.segs.length;if(o.select=0,e){for(i=0;i<r;++i)this.segs[i].select&&s++;this.numSelect=o.select=s+1,this.curAlpha=void 0==o.alpha?100:o.alpha,this.curCol=o.col,this.curDrop=o.drop,this.curEcol=o.ecol,this.curEtip=o.etip,this.curTsiz=o.tsiz,this.curTsty=o.tsty,this.curTfon=o.tfon,this.curCurve=o.curve,this.curText=o.text,this.curEwid=o.ewid}this.AddWireframe(t)},QDraw.prototype.AddPointToSeg=function(t,e){function i(t,e,i,s){var o=Math.abs((i.y-e.y)*t.x-(i.x-e.x)*t.y+i.x*e.y-i.y*e.x)/Math.sqrt(Math.pow(i.y-e.y,2)+Math.pow(i.x-e.x,2));if(o>s)return!1;var r=(i.x-t.x)*(e.x-t.x)+(i.y-t.y)*(e.y-t.y);if(r<0)return!1;var n=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y);return!(r>n)}var s,o,r,n={x:t,y:e},a=this.segs.length;for(this.Do(),s=0;s<a&&!this.segs[s].select;++s);if(s!=a&&!(this.segs[s].type>2)){var p=this.segs[s].x,c=this.segs[s].y;for(s=0;s<p.length-1&&(o={x:p[s],y:c[s]},r={x:p[s+1],y:c[s+1]},!i(o,r,n,10));++s);p.splice(++s,0,t),c.splice(s,0,e),this.RefreshSVG(),Sound("ding")}},QDraw.prototype.CalMiniMax=function(t){var e,i={minx:999999,maxx:-999999,miny:999999,maxy:-999999},s=this.segs[t].x,o=this.segs[t].y;for(e=0;e<s.length;++e)s[e]<i.minx&&(i.minx=s[e]),o[e]<i.miny&&(i.miny=o[e]),s[e]>i.maxx&&(i.maxx=s[e]),o[e]>i.maxy&&(i.maxy=o[e]);return 5==this.segs[t].type&&(i.maxx=i.minx+this.segs[t].svg.getBBox().width,i.miny=i.miny-.66*this.segs[t].svg.getBBox().height,i.maxy=i.miny+.66*this.segs[t].svg.getBBox().height),i.dx=i.maxx-i.minx,i.dy=i.maxy-i.miny,i.cx=i.minx+i.dx/2,i.cy=i.miny+i.dy/2,i},QDraw.prototype.DeselectSegs=function(){var t,e=this.segs.length;for(this.numSelect=0,t=0;t<e;++t)this.segs[t].select=0,$("#QWire-"+t).remove()},QDraw.prototype.ArrangeSegs=function(t){var e,i=-1,s=[];for(this.Do(),e=0;e<this.segs.length;++e)this.segs[e].select&&(i<0&&(i=e),s.push(JSON.parse(JSON.stringify(this.segs[e]))),this.segs.splice(e,1),--e);switch(s.sort(function(t,e){return t.select<e.select?-1:1}),t){case 1:for(e=0;e<s.length;++e)this.segs.unshift(s[e]);break;case 2:for(i--,e=0;e<s.length;++e)this.segs.splice(i,0,s[e]);break;case 3:for(i++,e=0;e<s.length;++e)this.segs.splice(i,0,s[e]);break;case 4:for(e=0;e<s.length;++e)this.segs.push(s[e])}for(this.RefreshSVG(),e=0;e<this.segs.length;++e)this.segs[e].select&&this.AddWireframe(e);Sound("ding")},QDraw.prototype.AlignSegs=function(t){var e,i,s,o,r,n,a,p=[],c=[],l=999999,d=999999,h=-999999,u=-999999;for(this.Do(),e=0;e<this.segs.length;++e)this.segs[e].select&&(p[e]=this.CalMiniMax(e),c.push({ind:e,pos:p[e]}),r||(r=p[e]));11==t&&c.sort(function(t,e){return t.pos.minx<e.pos.minx?-1:1}),12==t&&c.sort(function(t,e){return t.pos.miny<e.pos.miny?-1:1});var g=c.length;if(t>9){var f=0,x=0;for(i=0;i<g;++i)e=c[i].ind,p[e].minx<l&&(l=p[e].minx),p[e].miny<d&&(d=p[e].miny),p[e].maxx>h&&(h=p[e].maxx),p[e].maxy>u&&(u=p[e].maxy),f+=p[e].dx,x+=p[e].dy;f=(h-l-f)/Math.max(g-1,1),x=(u-d-x)/Math.max(g-1,1),--g}for(i=1;i<g;++i)for(e=c[i].ind,o=c[i-1].ind,n=a=0,1==t?a=r.miny-p[e].miny:2==t?a=r.cy-p[e].cy:3==t?a=r.maxy-p[e].maxy:4==t?n=r.minx-p[e].minx:5==t?n=r.cx-p[e].cx:6==t?n=r.maxx-p[e].maxx:11==t?n=p[o].maxx+f-p[e].minx:12==t&&(a=p[o].maxy+x-p[e].miny),s=0;s<this.segs[e].x.length;++s)this.segs[e].x[s]+=n,this.segs[e].y[s]+=a;this.RefreshSVG(),Sound("ding")},QDraw.prototype.RefreshIds=function(){var t,e=this.segs.length;for(t=0;t<e;++t)this.segs[t].svg.setAttribute("id","QSeg-"+t)},QDraw.prototype.StyleSelectedSegs=function(){var t,e,i=this.segs.length;for(this.Do(),t=0;t<i;++t)this.segs[t].select&&(e=this.segs[t],e.col=this.curCol,e.drop=this.curDrop,e.alpha=this.curAlpha,e.ewid=this.curEwid,e.ecol=this.curEcol,e.etip=this.curEtip,e.tsiz=this.curTsiz,e.tsty=this.curTsty,e.tfon=this.curTfon,e.curve=this.curCurve,e.text=this.curText,this.StyleSeg(t),this.changed=!0)},QDraw.prototype.AddWireframe=function(t,e){function s(i,s,r,a){var p=document.createElementNS(o.NS,"rect");n.appendChild(p),p.setAttribute("height",6),p.setAttribute("width",6),p.setAttribute("x",i-3),p.setAttribute("y",s-3),p.style.fill=e,p.setAttribute("id","QWireDot-"+t+"-"+a),p.setAttribute("cursor","alias"),p.addEventListener("mousedown",function(t){var e=t.target.id.split("-");return o.tempSeg=JSON.parse(JSON.stringify(o.segs)),t.ctrlKey&&o.segs[e[1]].type<3&&o.segs[e[1]].x.length>2?(o.Do(),o.segs[e[1]].x.splice(e[2]-1,1),o.segs[e[1]].y.splice(e[2]-1,1),o.RefreshSVG(),void Sound("delete")):(o.drawMode="ds-"+e[1]+"-"+a,o.mouseX=t.clientX,void(o.mouseX=t.clientY))})}var o=this;if($("#QWire-"+t).remove(),this.segs[t].select)e="#3399ff";else if(!e)return;var r=this.segs[t],n=document.createElementNS(this.NS,"g");if(this.svg.appendChild(n),n.setAttribute("id","QWire-"+t),r.type<3){var a=document.createElementNS(this.NS,"path");n.appendChild(a);var p="M"+r.x[0]+" "+r.y[0];if(r.curve>0){var c=!0;for(Math.abs(r.x[0]-r.x[r.x.length-1])<3&&Math.abs(r.y[0]-r.y[r.y.length-1])<3&&(r.x[x.length-1]=r.x[0],r.y[y.length-1]=r.y[0],c=!1),x=r.x[0]-0+(r.x[1]-r.x[0])/2-0,y=r.y[0]-0+(r.y[1]-r.y[0])/2-0,c&&(p+="L"+x+",",p+=y+" "),j=1;j<r.x.length-1;++j)x=r.x[j]-0+(r.x[j+1]-r.x[j])/2-0,y=r.y[j]-0+(r.y[j+1]-r.y[j])/2-0,p+="Q",p+=r.x[j]+",",p+=r.y[j]+" ",p+=x+",",p+=y+" ";c&&(p+="L"+r.x[j]+",",p+=r.y[j]+" ")}else for(j=1;j<r.x.length;++j)p+="L",p+=r.x[j]+",",p+=r.y[j]+" ";for(r.col&&"None"!=r.col&&(p+=" Z"),a.setAttribute("d",p),a.style.fill="none",a.style.stroke=e,a.setAttribute("stroke-width","1px"),i=0;i<r.x.length;++i)s(r.x[i],r.y[i],a,i+1)}else if("3"==r.type){var a=document.createElementNS(this.NS,"rect");n.appendChild(a),a.setAttribute("height",Math.abs(r.y[2]-r.y[0])),a.setAttribute("width",Math.abs(r.x[2]-r.x[0])),a.setAttribute("x",r.x[0]),a.setAttribute("y",r.y[0]),a.style.fill="none",a.style.stroke=e,a.setAttribute("stroke-width","1px"),s(r.x[0],r.y[0],a,1),s(r.x[1],r.y[1],a,2),s(r.x[2],r.y[2],a,3),s(r.x[3],r.y[3],a,4)}else if("4"==r.type){var a=document.createElementNS(this.NS,"ellipse");n.appendChild(a);var l=Math.abs(r.x[2]-r.x[0])/2;a.setAttribute("rx",l);var d=Math.abs(r.y[2]-r.y[0])/2;a.setAttribute("ry",d),a.setAttribute("cx",r.x[0]+l),a.setAttribute("cy",r.y[0]+d),a.style.fill="none",a.style.stroke=e,a.setAttribute("stroke-width","1px"),s(r.x[0],r.y[0],a,1),s(r.x[1],r.y[1],a,2),s(r.x[2],r.y[2],a,3),s(r.x[3],r.y[3],a,4)}else if("5"==r.type){var a=document.createElementNS(this.NS,"rect");n.appendChild(a);var l=r.svg.getBBox().width,d=.66*r.svg.getBBox().height;a.setAttribute("height",d),a.setAttribute("width",l),a.setAttribute("x",r.x[0]),a.setAttribute("y",r.y[0]-d),a.style.fill="none",a.style.stroke=e}},QDraw.prototype.DrawShape=function(t){t&&(this.drawMode="newxy-0-"+t,this.pie.ShowPieMenu(!1),this.curShape=t,this.DrawMenu(),Sound("click"),$("#Q-SVG").attr("cursor","crosshair"))},QDraw.prototype.Rubberband=function(t,e,i,s,o,r){var n,p,c;if($("#QRubber").remove(),!(t<1||t>4)){var l=Math.abs(o-i)/2,d=Math.abs(s-e)/2;this.gridSnap&&(e-=e%this.gridSnap,i-=i%this.gridSnap,s-=s%this.gridSnap,o-=o%this.gridSnap),t<3&&(r&&(p=s-e,c=o-i,a=180-Math.atan2(p,c)*(180/Math.PI),a<45?s=e+1:a<135?o=i+1:a<225?s=e+1:a<315?o=i+1:s=e+1),n=document.createElementNS(this.NS,"line"),n.setAttribute("x1",e),n.setAttribute("y1",i),n.setAttribute("x2",s),n.setAttribute("y2",o)),3==t?(r&&(l=d),n=document.createElementNS(this.NS,"rect"),n.setAttribute("height",l+l),n.setAttribute("width",d+d),n.setAttribute("x",e),n.setAttribute("y",i)):4==t?(r&&(l=d),n=document.createElementNS(this.NS,"ellipse"),n.setAttribute("ry",l),n.setAttribute("rx",d),n.setAttribute("cx",e+d),n.setAttribute("cy",i+l)):5==t&&(n=document.createElementNS(this.NS,"text"),n.setAttribute("height",l+l),n.setAttribute("width",d+d),n.setAttribute("x",e),n.setAttribute("y",i)),this.svg.appendChild(n),n.setAttribute("id","QRubber"),n.style.fill="none",n.style.stroke="#3399ff",n.setAttribute("stroke-width","2px"),n.setAttribute("filter","url(#QdropFilterR)")}},QDraw.prototype.AddDropFilter=function(t,e,i){var s=document.createElementNS(this.NS,"filter");s.setAttribute("id",t),s.setAttribute("width","200%"),s.setAttribute("height","200%");var o=document.createElementNS(this.NS,"feOffset");o.setAttribute("result","offOut"),o.setAttribute("in","SourceGraphic"),o.setAttribute("dx","1"),o.setAttribute("dy","1");var r=document.createElementNS(this.NS,"feGaussianBlur");r.setAttribute("result","blurOut"),r.setAttribute("in","matrixOut"),r.setAttribute("stdDeviation",i);var n=document.createElementNS(this.NS,"feBlend");n.setAttribute("in","SourceGraphic"),n.setAttribute("in2","blurOut"),n.setAttribute("mode","normal");var a=document.createElementNS(this.NS,"feColorMatrix");a.setAttribute("in","offOut"),a.setAttribute("result","matrixOut"),a.setAttribute("type","matrix"),"#ffffff"==e?a.setAttribute("values","-1 0 0 0 1 0 -1 0 0 1 0 0 -1 0 1 0 0 0 1 0"):a.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0");var p=document.getElementById("SVG-defs");p||(p=document.createElementNS(this.NS,"defs"),p.setAttribute("id","SVG-defs"),p=this.svg.appendChild(p)),s=p.appendChild(s),s.appendChild(o),s.appendChild(a),s.appendChild(r),s.appendChild(n)},QDraw.prototype.AddSeg=function(t){var e,i=this,s=this.segs[t];s.svg||(1==s.type?(type="path",s.svg=document.createElementNS(this.NS,"g"),this.svg.appendChild(s.svg)):2==s.type?type="path":3==s.type?type="rect":4==s.type?type="ellipse":5==s.type&&(type="text"),1==s.type?(e=document.createElementNS(this.NS,type),s.svg.appendChild(e),e.setAttribute("id","QPth-"+t),e=document.createElementNS(this.NS,type),e.setAttribute("id","QTps-"+t),s.svg.appendChild(e),e=document.createElementNS(this.NS,type),e.setAttribute("id","QTpe-"+t),s.svg.appendChild(e)):(s.svg=document.createElementNS(this.NS,type),this.svg.appendChild(s.svg)),s.svg.setAttribute("id","QSeg-"+t),s.svg.setAttribute("cursor","pointer"),s.svg.addEventListener("mouseout",function(t){var e=t.target.id.substr(5);i.AddWireframe(e)}),s.svg.addEventListener("mouseover",function(t){var e=t.target.id.substr(5);"ds"!=i.drawMode.substr(0,2)&&i.AddWireframe(e,"#ff0000")}),s.svg.addEventListener("contextmenu",function(t){var e,s=i.pie.ops.wid/2;for(e=0;e<i.segs.length;++e)if(i.segs[e].select){i.curShape=i.segs[e].type;break}var o=i.CalMiniMax(e);i.pie.ops.segMode=!0,i.pie.ops.x=o.cx-s,i.pie.ops.y=o.cy-s,i.pie.ShowPieMenu(!i.pie.active),i.DrawMenu()}),s.svg.addEventListener("mousedown",function(t){var e=t.target.id.substr(5),s=i.segs[e];t.shiftKey?i.SelectSeg(e,!0):(i.DeselectSegs(),i.SelectSeg(e,!0)),i.tempSeg=JSON.parse(JSON.stringify(i.segs)),Sound("click"),i.AddWireframe(e),i.drawMode="ds-"+e+"-0",i.mouseX=t.clientX,i.mouseY=t.clientY,i.mouseDX=t.clientX-s.x[0],i.mouseDY=t.clientY-s.y[0]}))},QDraw.prototype.EndDrawing=function(){this.drawMode&&this.drawMode.match(/newxy/)&&(this.drawMode="",this.Rubberband(0),Sound("click"),$("#Q-SVG").attr("cursor","default"),this.segs[this.segs.length-1].x.length<2&&(this.segs.pop(),this.RefreshSVG()))},QDraw.prototype.RemoveLastPoint=function(){if(this.drawMode&&this.drawMode.match(/newxy/)&&this.segs[this.segs.length-1].x.length>1){Sound("delete");var t=this.segs.length-1;this.segs[t].x.pop(),this.segs[t].y.pop();var e=this.segs[t].x.length-1;this.drawX=this.segs[t].x[e],this.drawY=this.segs[t].y[e],this.RefreshSVG()}};